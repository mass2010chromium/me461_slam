<!DOCTYPE html>
<html scroll-behavior="smooth">
    <head>
        <meta charset="UTF-8" />
    </head>
    <body>
        <div id="svgcontainer" style="position: absolute; left: 0px; top: 0px; margin: 10px; z-index: 2;">
        </div>
        <div style="position: absolute; left: 0px; top: 0px; width: 410px; height: 410px; margin: 5px; z-index: 1; background-color: black">
            <img src="map" style="margin: 5px"/>
        </div>
        <div id="joyDiv" style="position: absolute; top: 460px; left: 0px; width:200px;height:200px;margin-bottom:20px;"></div>
        <div id="main" style="position: absolute; top: 430px; z-index: 3">
            mmm
        </div>
        <div style="position: absolute; left: 700px; top: 0px; z-index: 1; margin: 5px;">
            <img src="stream" />
        </div>

        <script type = "text/javascript" src = "https://d3js.org/d3.v4.min.js"></script>
        <script type = "text/javascript" src = "include/joy_min.js"></script>
        <script>
            var joy = new JoyStick('joyDiv');

            var width = 400;
            var height = 400;
            var svg = d3.select("#svgcontainer")
                .append("svg").attr("width", width).attr("height", height);
            const bb = d3.select('#svgcontainer').node().getBoundingClientRect();

            const xScale = d3.scaleLinear()
                .domain([-3, 3])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([-3, 3])
                .range([height, 0]);

            const line = d3.line()
                .curve(d3.curveNatural)
                .x(d => xScale(d[0]))
                .y(d => yScale(d[1]));

            const line2 = d3.line()
                .curve(d3.curveNatural)
                .x(d => xScale(d[0]))
                .y(d => yScale(d[1]));

            let points = [];
            svg.append('path').attr('d', line(points));
            svg.append('line').style('stroke', 'orange');

            // TODO: stream instead of spam http
            let target_div = document.getElementById("main");
            function refresh() {
                fetch("pose_slam")
                    .then(rs => rs.json())
                    .then(dat => {
                        target_div.innerHTML = JSON.stringify(dat);
                        setTimeout(refresh, 20);
                        if (points.length >= 1000) {
                            points.shift();
                        }
                        points.push([dat.x, dat.y]);
                        const pointer_dist = 0.1;

                        svg.selectAll('path')
                           .data([points])
                           .attr('d', line)
                           .attr('stroke', 'black')
                           .attr('fill', 'none');
                        svg.selectAll('line')
                           .attr('x1', xScale(dat.x))
                           .attr('y1', yScale(dat.y))
                           .attr('x2', xScale(dat.x + pointer_dist * Math.cos(dat.heading)))
                           .attr('y2', yScale(dat.y + pointer_dist * Math.sin(dat.heading)));

                        const v_command = joy.GetY() / 500.0;
                        const w_command = -joy.GetX() / 100.0;
                        if (v_command != 0 || w_command != 0) {
                            let data = { v: v_command, w: w_command };
                            fetch("raw", {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify(data)
                                });
                                //.then(res => console.log("command sent"));
                        }
                    });
            }
            setTimeout(refresh, 20);
        </script>
    </body>
</html>
